classificationHigh:"هجوم تصيّد متقدم",
feedReady:"النظام جاهز..."
}
};

// ====== Set Language ======
function setLang(l){
lang = l;
document.getElementById("title").innerText = texts[lang].title;
document.getElementById("subtitle").innerText = texts[lang].subtitle;
document.getElementById("threatLabel").innerText = texts[lang].threatLabel;
document.getElementById("riskText").innerText = texts[lang].riskText;
document.getElementById("statsLabel").innerText = texts[lang].statsLabel;
document.getElementById("feedLabel").innerText = texts[lang].feedLabel;
document.getElementById("feed").innerText = texts[lang].feedReady;
playSound('switch');
}

// ====== Sounds ======
function playSound(type){
let audio;
if(type==='high') audio=document.getElementById('highSound');
else if(type==='medium') audio=document.getElementById('mediumSound');
else if(type==='safe') audio=document.getElementById('safeSound');
else if(type==='switch') audio=document.getElementById('switchSound');
else if(type==='hover') audio=document.getElementById('hoverSound');
if(audio){ audio.currentTime=0; audio.play();}
}

// ====== Text-to-Speech ======
function speak(text){
let s = new SpeechSynthesisUtterance(text);
s.lang = lang==='ar' ? 'ar-SA' : 'en-US';
speechSynthesis.cancel();
speechSynthesis.speak(s);
}

// ====== Patterns ======
const patterns = {
urgency:/verify your account|تحقق من حسابك الآن|سيتم إيقاف حسابك|نشاط غير معتاد/i,
sensitive:/otp|cvv|رقم البطاقة|كلمة المرور|iban/i,
links:/https?:\/\/|\.ru|\.xyz|bit\.ly|secure-login|verify-now/i,
financial:/استرداد|refund|دفعة معلقة/i,
puny:/xn--/i
};

// ====== Domain Reputation ======
function domainReputation(text){
let match=text.match(/https?:\/\/([^\/\s]+)/);
if(!match) return lang==='ar'?"لا يوجد دومين":"No Domain Detected";
let domain=match[1];
if(domain.includes(".ru")||domain.includes(".xyz")) return lang==='ar'?"نطاق عالي الخطورة":"High Risk TLD";
if(domain.includes("xn--")) return lang==='ar'?"مريب Punycode":"Punycode Suspicious";
if(domain.includes("secure")||domain.includes("verify")) return lang==='ar'?"تلاعب بالكلمات":"Keyword Manipulation";
return lang==='ar'?"مجهول / متوسط الخطورة":"Unknown / Medium Risk";
}

// ====== Analyze Function ======
function analyze(){
let t=document.getElementById("msg").value.toLowerCase();
if(t.length<5) return;

let score=0, mitre=[];

if(patterns.urgency.test(t)){score+=25; mitre.push("T1566");}
if(patterns.sensitive.test(t)){score+=30; mitre.push("T1555");}
if(patterns.links.test(t)){score+=25; mitre.push("T1204");}
if(patterns.financial.test(t)){score+=20;}
if(patterns.puny.test(t)){score+=20;}

let domainStatus=domainReputation(t);
if(domainStatus==="High Risk TLD"||domainStatus==="نطاق عالي الخطورة") score+=25;
if(domainStatus==="Punycode Suspicious"||domainStatus==="مريب Punycode") score+=30;

if(score>100) score=100;

let status="", classification="";

if(score>=75){status=texts[lang].statusHigh;classification=texts[lang].classificationHigh; stats.high++; playSound('high');}
else if(score>=40){status=texts[lang].statusMedium;classification=texts[lang].classificationMedium; stats.medium++; playSound('medium');}
else{status=texts[lang].statusSafe; classification=texts[lang].classificationSafe; stats.safe++; playSound('safe');}

document.getElementById("status").innerText=status;
document.getElementById("score").innerText=score;
document.getElementById("bar").style.width=score+"%";
document.getElementById("classification").innerText=classification;
document.getElementById("mitre").innerText=mitre.join(", ")||"—";
document.getElementById("domainRep").innerText=domainStatus;
document.getElementById("feed").innerText = status + " (" + score + "%) - " + new Date().toLocaleTimeString();

speak(`${status}. ${classification}. Score ${score}%.`);

updateChart();
}

// ====== Event Listener ======
const msgBox = document.getElementById("msg");
msgBox.addEventListener("input",analyze);
msgBox.addEventListener("mouseenter", ()=>playSound('hover'));

// ====== Chart ======
let chart=new Chart(document.getElementById("chart"),{
type:'doughnut',
data:{labels:['Safe','Suspicious','High Risk'],
datasets:[{data:[0,0,0], backgroundColor:['#00ffb3','#ffd633','#ff4d4d'] }]
}
});
function updateChart(){ chart.data.datasets[0].data=[stats.safe,stats.medium,stats.high]; chart.update();}
</script>

</body>
</html>
